# mini-dotfiles: zshrc (minimal, platform-agnostic)

# History and completion
HISTFILE=${ZDOTDIR:-$HOME}/.zsh_history
HISTSIZE=5000
SAVEHIST=5000
setopt HIST_IGNORE_DUPS SHARE_HISTORY

autoload -Uz compinit && compinit

# Prompt (simple): '#' for root, '$' for others
# `%(#.#.$)` -> `#` if uid==0 else `$`
PROMPT='%n@%m:%~ %(#.#.$) '

# Aliases
alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'

# Shared aliases
if [ -f "$HOME/.aliases.sh" ]; then
  source "$HOME/.aliases.sh"
fi

# Common user bin path
export PATH="$HOME/.deno/bin:$PATH"
export PATH="$HOME/.local/bin:$PATH"

# Include user fzf bin (git-based install) if present
if [ -d "$HOME/.fzf/bin" ]; then
  export PATH="$HOME/.fzf/bin:$PATH"
fi

# Homebrew PATH (macOS) if available
if [ -d "/opt/homebrew/bin" ]; then
  export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:$PATH"
fi
if [ -d "/usr/local/bin" ]; then
  export PATH="/usr/local/bin:/usr/local/sbin:$PATH"
fi

# fzf completion and keybindings (prefer self-printing integration when available)
if command -v fzf >/dev/null 2>&1; then
  if fzf --help 2>&1 | grep -q -- '--zsh'; then
    eval "$(fzf --zsh)" 2>/dev/null && __FZF_INTEGRATION_LOADED=1 || true
  fi
fi

# Fallbacks for older distro fzf (no --zsh). Skip if already loaded.
if [ -z "${__FZF_INTEGRATION_LOADED-}" ]; then
  if command -v brew >/dev/null 2>&1; then
    FZF_BREW_PREFIX="$(brew --prefix 2>/dev/null)"
    if [ -n "$FZF_BREW_PREFIX" ]; then
      [ -f "$FZF_BREW_PREFIX/opt/fzf/shell/completion.zsh" ] && source "$FZF_BREW_PREFIX/opt/fzf/shell/completion.zsh"
      [ -f "$FZF_BREW_PREFIX/opt/fzf/shell/key-bindings.zsh" ] && source "$FZF_BREW_PREFIX/opt/fzf/shell/key-bindings.zsh"
    fi
  fi

  [ -f "/usr/share/fzf/completion.zsh" ] && source "/usr/share/fzf/completion.zsh"
  [ -f "/usr/share/fzf/key-bindings.zsh" ] && source "/usr/share/fzf/key-bindings.zsh"

  [ -f "/usr/share/doc/fzf/examples/completion.zsh" ] && source "/usr/share/doc/fzf/examples/completion.zsh"
  [ -f "/usr/share/doc/fzf/examples/key-bindings.zsh" ] && source "/usr/share/doc/fzf/examples/key-bindings.zsh"

  # Some distros gzip the example scripts; source them if present
  if [ -f "/usr/share/doc/fzf/examples/completion.zsh.gz" ] && command -v gzip >/dev/null 2>&1; then
    source <(gzip -dc /usr/share/doc/fzf/examples/completion.zsh.gz)
  fi
  if [ -f "/usr/share/doc/fzf/examples/key-bindings.zsh.gz" ] && command -v gzip >/dev/null 2>&1; then
    source <(gzip -dc /usr/share/doc/fzf/examples/key-bindings.zsh.gz)
  fi

  [ -f "$HOME/.fzf/shell/completion.zsh" ] && source "$HOME/.fzf/shell/completion.zsh"
  [ -f "$HOME/.fzf/shell/key-bindings.zsh" ] && source "$HOME/.fzf/shell/key-bindings.zsh"
fi

# Starship prompt (if installed)
if command -v starship >/dev/null 2>&1; then
  eval "$(starship init zsh)"
fi

[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# Editor defaults
export EDITOR="nvim"
export VISUAL="nvim"

# Nicer man pages via bat when available
if command -v bat >/dev/null 2>&1; then
  export MANPAGER="sh -c 'col -bx | bat -l man -p'"
fi

# Nix profile
export PATH="$HOME/.nix-profile/bin:$PATH"
